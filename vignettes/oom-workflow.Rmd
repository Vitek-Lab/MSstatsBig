---
title: "Working with large sparse label DIA data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with large sparse label DIA data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Processing out-of-memory data with MSstatsBig

Converting a Spectrounat file that does not fit in memory with MSstats requires two steps.
First, `cleanBigSpectronautArrow` function applies filters and column selection to reduce the size of input file.
Data can be filtered with `EG.Identified` column (`filter_by_excluded` function) and both protein-, and psm-level q-values (`filter_by_qvalue` and `qvalue_cutoff` functions).
Additionally, source column for intensity can be selected. By default, `F.PeakArea` column is used.
This does not return any R output. Instead, it creates a csv file with reduced data set.
If such data set fits in memory and does not require special treatment for sparse labels, it can be processed with standard `MSstatsConvert` functions.
If sparse label processing is needed or the data set doesn't fit in memory, `BigSpectronauttoMSstatsFormat` function can be used to convert the reduced data set into full `MSstats` format by aggregating multiple observations per featuring and run, removing features with a low number of observations, and removing shared peptides.
Again, this function does not return any R output. Instead, it creates a file given by its second parameter.

```{r }
library(MSstatsBig)
cleanBigSpectronautArrow("spectronaut_output.csv", # input file
                         "msstats_spectronaut_init.csv", # user-selected name for output file
                         intensity = "F.PeakArea", # name of Intensity column
                         filter_by_excluded = TRUE, # filter by ExcludedFromQuantification column
                         filter_by_identified = TRUE, # filter by EG.Identified column
                         filter_by_qvalue = TRUE, # Filter by columns PG.Qvalue and EG.Qvalue
                         qvalue_cutoff = 0.01) # Q-value cutoff
BigSpectronauttoMSstatsFormat("msstats_spectronaut_init.csv", # output of cleanBigSpectronautArrow
                              "oom_output.csv") # user-selected name for output file
```

# Processing Sparse Label DIA data

We assume that output of our processing fits in RAM memory.
In this case, we can read the output of `BigSpectronauttoMSstatsFormat` into R to perform data summarization.

```{r }
bigspec = data.table::fread("oom_output.csv")
head(bigspec)
```

Function `dataProcessLabeled` is wrapper around `MSstats::dataProcess` capable of processing heavy and light peptides separately. Unlike the `MSstats` version, it does not require a labeled counterpart for each peptide. 
This function is simplified to suit large data better.
Required input is restricted to input data and imputation choice. We recommended not imputing the data, since imputation is the most time- and memory-consuming step of the MSstats workflow.

```{r }
processed = MSstatsBig::dataProcessLabeled(bigspec, impute = FALSE)
```

QC plots (summary and features for heavy and light channels) for selected proteins can be plotted using the `plotLabeledProfiles` function.

```{r }
MSstatsBig::plotLabeledProfiles(processed, "P06744") 
```
